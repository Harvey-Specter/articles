# master/slave の複製データの整合性を確保する方法
> MySQL マスター/スレーブ レプリケーション環境で、マスター/スレーブ データの一貫性を確保するにはどうすればよいですか?

## master/slave レプリケーションについて
一般的に使用される MySQL 高可用性ソリューションのほとんどは、MySQL のマスター/スレーブ レプリケーション (replication) に基づいて設計されており、従来の 1 マスター 1 スレーブ、デュアル マスター モード、または準同期レプリケーション (semi-sync replxxication) が含まれます。

MySQL のレプリケーションは MySQL の同期 (sync) とよく言われますが、実際にはこのプロセスは非同期 (async) です。 プロセスはおそらく次のようになります。

1. master でトランザクションを送信し、binlog に書き込むと、トランザクションの成功マークが返されます。
2. binlog をスレーブに送信し、relay ログにダンプします。
3. slave で relay log を読み、適用します。

步骤1和步骤3之间是异步进行的，无需等待确认各自的状态，所以说MySQL replicaxxtion是异步的。

ステップ 1 と 3 は非同期で実行され、それぞれの状態の確認を待つ必要がないため、MySQL replicationは非同期です。

MySQL semi-sync replicaationは、以前のベースで強化および改善されており、全体のプロセスは次のようになりました。

1. まず、master と少なくとも 1 つの slave の両方で、semi-sync の複製モードを有効にする必要があります。
2. slave が master に接続されると、slave は、現在 semi-sync モードにあるかどうかをアクティブに通知します。
3. master でトランザクションを送信して binlog に書き込んだ後、少なくとも 1 つのスレーブにトランザクションの受信を通知し、relay log が書き込まれてディスクに正常にフラッシュされるのを待ち、確認通知を送信する必要があります。スレーブ ノードがマスターへのトランザクションを完了したこと。
4. master が上記の通知を受け取った後、トランザクションの送信を実際に完了し、トランザクションの成功マークを返すことができます。
5. 上記の手順で、slave から master への通知時間が rpl_semi_sync_master_timeout の設定値を超えると、マスター/スレーブ関係が semi-sync モードから従来の非同期レプリケーション モードに自動的に調整されます。

準同期レプリケーションは非常に良さそうであり、その可能性はありませんが、ネットワーク品質が高くない場合、上記の 5 番目の状況をトリガーするジッタがある場合、準同期レプリケーションから通常のレプリケーションにダウングレードされます。準同期レプリケーションを使用すると、master での tps パフォーマンスの低下が非常に深刻で、最悪の場合は 50% 以上低下する可能性があります。

この観点から、厳密にデータの整合性を確保する必要がある場合や、その他のやむを得ない場合を除き、準同期レプリケーションを使用することはお勧めしません。 もちろん、実際には、プログラムの論理制御を強化することで、マスターとスレーブのデータが一致しない場合の論理エラーを回避することもできます。 または、実行頻度が適切である限り、pt-table-checksum および pt-table-sync ツールを使用してデータを検証および修復することもできます。

複数のノード間のデータの一貫性を本当に改善したい場合は、PXC ソリューションの使用を検討できます。 初期段階で PXC に専念できる人がチームにいない場合は、注意が必要です. 結局、従来のマスター/スレーブ レプリケーションとは大きく異なります. 問題が発生すると、より多くのエネルギーが必要になります.トラブルシューティングして解決します。

## マスター/スレーブ レプリケーション データの一貫性を確保する方法

非同期レプリケーション、準同期レプリケーション、および PXC について説明した後、トピックに戻りましょう: 従来のマスター/スレーブ レプリケーション シナリオで、マスター/スレーブ データの一貫性を確保し、データ損失やその他の問題を回避するにはどうすればよいでしょうか?

MySQL では、トランザクションがコミットされた後、undo の書き込み、redo の書き込み、binlog の書き込み、データ ファイルの書き込みなどを行う必要があります。 この過程で、特定のステップでcrashが発生し、マスター/スレーブデータの不整合が発生する可能性があります。 この状況を回避するには、クラッシュが発生した場合でもマスター/スレーブ レプリケーションのデータ損失が発生しないように、マスター/スレーブ上の関連オプションの構成を調整する必要があります。

### 1. master の構成を変更する

        innodb_flush_log_at_trx_commit = 1
        sync_binlog = 1  

上記の 2 つのオプションの機能は、各トランザクションがコミットされた後、リアルタイムでディスクに更新できるようにすることです。特に、各トランザクションに対応する binlog を時間内にディスクに更新できるようにします。 binlog があり、InnoDB はデータを回復できます。これは、マスター/スレーブ レプリケーションでデータ損失が発生しないようにするためです。

### 2. slave の構成を変更する

        master_info_repository = "TABLE"
        relay_log_info_repository = "TABLE"
        relay_log_recovery = 1

上記の最初の 2 つのオプションの機能は次のとおりです。**スレーブ上のレプリケーションに関連するメタデータ テーブルも InnoDB エンジンを使用し、InnoDB トランザクション セキュリティによって保護されていることを確認します**。後者のオプションの機能は、リレーを有効にすることです。ログ自動修復メカニズム. crash が発生すると、部分的なデータ損失の可能性を回避するために、master から再取得して再度適用する必要がある Relaylogs を自動的に決定します。 **

上記のオプションを調整することで、マスターとスレーブの複製データが失われないようにすることができます。 ただし、**これはマスター/スレーブ データの絶対的な一貫性を保証するものではありません**。ignore\do\rewrite などのレプリケーション ルールを設定したり、一部の SQL 自体に不確実な要素があったり、スレーブ上のデータを人為的に変更したりする可能性があるためです。 、最終的にマスターとスレーブのデータの不整合につながります。 この場合、pt-table-checksum および pt-table-sync ツールを使用して、データ チェックサムの修復を実行できます。