# masterr/slave の複製データの整合性を確保する方法
> MySQL マスター/スレーブ レプリケーション環境で、マスター/スレーブ データの一貫性を確保するにはどうすればよいですか?

## master/slave レプリケーションについて
一般的に使用される MySQL 高可用性ソリューションのほとんどは、MySQL のマスター/スレーブ レプリケーション (replication) に基づいて設計されており、従来の 1 マスター 1 スレーブ、デュアル マスター モード、または準同期レプリケーション (semi-sync replxxication) が含まれます。

MySQL のレプリケーションは MySQL の同期 (sync) とよく言われますが、実際にはこのプロセスは非同期 (async) です。 プロセスはおそらく次のようになります。

1. master でトランザクションを送信し、binlog に書き込むと、トランザクションの成功マークが返されます。
2. binlog をスレーブに送信し、relay ログにダンプします。
3. slave で relay log を読み、適用します。

步骤1和步骤3之间是异步进行的，无需等待确认各自的状态，所以说MySQL replicaxxtion是异步的。

ステップ 1 と 3 は非同期で実行され、それぞれの状態の確認を待つ必要がないため、MySQL replicationは非同期です。

MySQL semi-sync replicaationは、以前のベースで強化および改善されており、全体のプロセスは次のようになりました。

1. まず、master と少なくとも 1 つの slave の両方で、semi-sync の複製モードを有効にする必要があります。
2. slave が master に接続されると、slave は、現在 semi-sync モードにあるかどうかをアクティブに通知します。
3. master でトランザクションを送信して binlog に書き込んだ後、少なくとも 1 つのスレーブにトランザクションの受信を通知し、relay log が書き込まれてディスクに正常にフラッシュされるのを待ち、確認通知を送信する必要があります。スレーブ ノードがマスターへのトランザクションを完了したこと。
4. master が上記の通知を受け取った後、トランザクションの送信を実際に完了し、トランザクションの成功マークを返すことができます。
5. 上記の手順で、slave から master への通知時間が rpl_semi_sync_master_timeout の設定値を超えると、マスター/スレーブ関係が semi-sync モードから従来の非同期レプリケーション モードに自動的に調整されます。

半同步复制看起来很美好有木有，但如果网络质量不高，是不是出现抖动，触发上述第5条的情况，会从半同步复制降级为普通复制；此外，采用半同步复制，会导致master上的tps性能下降非常严重，最严重的情况下可能会损失50%以上。

这样来看，除非需要非常严格保证数据一致性等迫不得已的场景，就不太建议使用半同步复制了。当然了，事实上我们也可以通过加强程序端的逻辑控制，来避免主从数据不一致时发生逻辑错误，比如说如果在从上读取到的数据和主不一致的话，那么就触发主从间的一次数据修复工作。或者，我们也可以用 pt-table-checksum & pt-table-sync 两个工具来校验并修复数据，只要运行频率适当，是可行的。

真想要提高多节点间的数据一致性，可以考虑采用PXC方案。现在已知用PXC规模较大的有qunar、sohu，如果团队里初期没有人能比较专注PXC的话，还是要谨慎些，毕竟和传统的主从复制差异很大，出现问题时需要花费更多精力去排查解决。

## 如何保证主从复制数据一致性
上面说完了异步复制、半同步复制、PXC，我们回到主题：在常规的主从复制场景里，如何能保证主从数据的一致性，不要出现数据丢失等问题呢？

在MySQL中，一次事务提交后，需要写undo、写redo、写binlog，写数据文件等等。在这个过程中，可能在某个步骤发生crash，就有可能导致主从数据的不一致。为了避免这种情况，我们需要调整主从上面相关选项配置，确保即便发生crash了，也不能发生主从复制的数据丢失。

### 1. 在master上修改配置  

        innodb_flush_log_at_trx_commit = 1
        sync_binlog = 1  

上述两个选项的作用是：保证每次事务提交后，都能实时刷新到磁盘中，尤其是确保每次事务对应的binlog都能及时刷新到磁盘中，只要有了binlog，InnoDB就有办法做数据恢复，不至于导致主从复制的数据丢失。

### 2. 在slave上修改配置

        master_info_repository = "TABLE"
        relay_log_info_repository = "TABLE"
        relay_log_recovery = 1

上述前两个选项的作用是：**确保在slave上和复制相关的元数据表也采用InnoDB引擎，受到InnoDB事务安全的保护**，而后一个选项的作用是**开启relay log自动修复机制，发生crash时，会自动判断哪些relay log需要重新从master上抓取回来再次应用，以此避免部分数据丢失的可能性。**

通过上面几个选项的调整，就可以确保主从复制数据不会发生丢失了。但是，**这并不能保证主从数据的绝对一致性**，因为，有可能设置了ignore\do\rewrite等replication规则，或者某些SQL本身存在不确定因素，或者人为在slave上修改数据，最终导致主从数据不一致。这种情况下，可以采用pt-table-checksum 和 pt-table-sync 工具来进行数据的校验和修复。